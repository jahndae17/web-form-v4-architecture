<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToolsContainer Demo - Reactive Drawing Application</title>
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Main Application Container */
        .app-container {
            width: 95vw;
            height: 90vh;
            background: #1a1a1a;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            overflow: hidden;
            position: relative;
        }

        /* Tools Container Styles */
        .tools-container {
            background: #2d2d2d;
            border-right: 2px solid #444;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            user-select: none;
            overflow: hidden; /* Prevent content overflow when collapsed */
        }

        .tools-container.panel-open {
            width: 200px;
        }

        .tools-container.panel-collapsed {
            width: 0px;
            overflow: hidden;
        }

        /* Tools Panel Header */
        .tools-header {
            height: 50px;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            border-bottom: 1px solid #444;
        }

        .tools-title {
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .panel-collapsed .tools-title {
            opacity: 0;
        }

        /* Tools Grid */
        .tools-grid {
            flex: 1;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 10px;
            align-content: start;
            overflow-y: auto;
        }

        .panel-collapsed .tools-grid {
            padding: 10px 5px;
            grid-template-columns: 1fr;
        }

        /* Tool Item */
        .tool-item {
            background: #3a3a3a;
            border: 2px solid #555;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .tool-item:hover {
            background: #4a4a4a;
            border-color: #777;
            /* Transform removed - handled by Graphics Handler */
        }

        .tool-item.selected {
            background: #4a90e2;
            border-color: #5aa3f0;
        }

        .tool-item.active {
            background: #27ae60;
            border-color: #2ecc71;
            box-shadow: 0 0 10px rgba(46, 204, 113, 0.3);
        }

        .tool-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .tool-name {
            color: #fff;
            font-size: 10px;
            font-weight: 500;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .panel-collapsed .tool-name {
            opacity: 0;
        }

        /* Canvas Area */
        .canvas-area {
            flex: 1;
            background: white;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin: 0px;
        }

        /* Status Bar */
        .status-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: #333;
            color: #fff;
            display: flex;
            align-items: center;
            padding: 0 15px;
            font-size: 12px;
            border-top: 1px solid #444;
        }

        .status-item {
            margin-right: 20px;
        }

        /* Mode Toggle Button */
        .mode-toggle-btn {
            background: #007acc;
            color: #fff;
            border: 1px solid #005a99;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.2s ease;
            margin-right: 0;
        }

        .mode-toggle-btn:hover {
            background: #005a99;
            border-color: #003d66;
            transform: translateY(-1px);
        }

        .mode-toggle-btn:active {
            transform: translateY(0);
        }

        .mode-toggle-btn.preview-mode {
            background: #28a745;
            border-color: #1e7e34;
        }

        .mode-toggle-btn.preview-mode:hover {
            background: #1e7e34;
            border-color: #155724;
        }

        /* Panel Toggle Button */
        .panel-toggle {
            background: #4a4a4a;
            color: #fff;
            border: 2px solid #666;
            border-radius: 6px;
            cursor: pointer;
            z-index: 1000;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .panel-toggle:hover {
            background: #5a5a5a;
            border-color: #888;
            /* Transform removed - handled by Graphics Handler */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .panel-toggle:active {
            /* Transform removed - handled by Graphics Handler */
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        /* Tool selection animations now handled by Graphics Handler */
        /* @keyframes toolSelect removed - Graphics Handler manages animations */

        /* Responsive Design */
        @media (max-width: 768px) {
            .app-container {
                width: 100vw;
                height: 100vh;
                border-radius: 0;
            }
            
            .tools-container.panel-open {
                width: 150px;
            }
            
            .tools-container.panel-collapsed {
                width: 0px;
                overflow: hidden;
            }
            
            .tools-grid {
                gap: 8px;
                padding: 10px;
            }
        }

        /* Scrollbar Styling */
        .tools-grid::-webkit-scrollbar {
            width: 6px;
        }

        .tools-grid::-webkit-scrollbar-track {
            background: #2d2d2d;
        }

        .tools-grid::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 3px;
        }

        .tools-grid::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Tools Container -->
        <div id="tools-container" class="tools-container panel-open">
            <div class="tools-header">
                <div class="tools-title">Drawing Tools</div>
            </div>
            <div class="tools-grid" id="tools-grid">
                <!-- Tools will be dynamically added here -->
            </div>
        </div>

        <!-- Canvas Area -->
        <div class="canvas-area" id="canvas-area" data-drop-zone="true" data-drop-zone-type="canvas">
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item" id="current-tool">Tool: None</div>
            <div class="status-item" id="tool-count">Tools: 0</div>
            <div class="status-item" id="panel-status">Panel: Open</div>
            <div class="status-item" id="app-mode">App Mode: Design</div>
            <button class="status-item mode-toggle-btn" id="mode-toggle" title="Toggle between Design and Preview modes">
                üé® Switch to Preview
            </button>
        </div>
    </div>

    <!-- Load ToolsContainer Implementation -->
    <script src="../Handler/Event Handler.js"></script>
    <script src="../Handler/Graphics Handler.js"></script>
    <script src="../Handler/Errors/SuddenPositionChangeDetector.js"></script>
    <script src="../Handler/Errors/SlingShotErrorDetector.js"></script>
    <script src="../Components/Developer Level/base container.js"></script>
    <script src="../Components/Developer Level/FormBuilderCanvas.js"></script>
    <script src="../Components/Developer Level/DragAndDropBehavior.js"></script>
    <script src="../Components/Developer Level/tools container.js"></script>
    <script src="../Components/Developer Level/ToolPanelToggleBehavior.js"></script>
    <script src="../Components/User Level/Base User Container/BaseUserContainer.js"></script>
    <script src="../Components/User Level/Base User Container/ResizeableBehavior.js"></script>
    <script src="../Components/User Level/Base User Container/SelectableBehavior.js"></script>
    <script src="../Components/User Level/Base User Container/MovableBehavior.js"></script>
    <script src="../Components/User Level/Base User Container/BaseUserContainerBehavior.js"></script>
    <script src="../Components/User Level/Base User Container/BaseUserContainerFactory.js"></script>
    
    <script>
        // ========================
        // REACTIVE ARCHITECTURE IMPLEMENTATION
        // Following Component Architecture Guidelines
        // ========================
        
        // Create Mock ChangeLog for system coordination
        class MockChangeLog {
            constructor() {
                this.context = new Map();
                this.subscriptions = new Map();
                this.handlers = new Set();
            }
            
            registerHandler(name) {
                this.handlers.add(name);
                console.log(`üìù ChangeLog: Handler ${name} registered`);
            }
            
            startListening(callback) {
                this.callback = callback;
                console.log('üìù ChangeLog: Started listening');
            }
            
            updateContext(path, value, action = 'update', meta = {}) {
                this.context.set(path, value);
                console.log(`üìù ChangeLog: Updated ${path}`);
                
                // Notify subscribers
                if (this.subscriptions.has(path)) {
                    this.subscriptions.get(path).forEach(callback => {
                        try {
                            callback(value);
                        } catch (error) {
                            console.error('ChangeLog callback error:', error);
                        }
                    });
                }
            }
            
            setValue(path, value) {
                this.updateContext(path, value, 'set');
            }
            
            getValue(path, defaultValue = null) {
                return this.context.get(path) ?? defaultValue;
            }
            
            subscribe(path, callback) {
                if (!this.subscriptions.has(path)) {
                    this.subscriptions.set(path, []);
                }
                this.subscriptions.get(path).push(callback);
                console.log(`üìù ChangeLog: Subscribed to ${path}`);
            }
        }

        // Initialize System Architecture
        class ReactiveToolsApplication {
            constructor() {
                this.systemInitialized = false;
                this.init();
            }

            async init() {
                console.log('üé® Initializing Reactive Tools Application...');
                
                try {
                    // 1. Create ChangeLog for system coordination
                    this.changeLog = new MockChangeLog();
                    
                    // Initialize global application mode state
                    this.changeLog.setValue('application.mode', 'design');
                    this.changeLog.setValue('application.mode_switching_enabled', true);
                    this.changeLog.setValue('application.available_modes', ['design', 'preview']);
                    console.log('üéõÔ∏è Global application mode initialized: design');
                    
                    // 2. Create and initialize Event Handler
                    this.eventHandler = new EventHandler(this.changeLog);
                    console.log('‚ö° Event Handler initialized');
                    
                    // 3. Create and initialize Graphics Handler with dependencies
                    this.graphicsHandler = new GraphicsHandler(this.eventHandler, this.changeLog);
                    await this.graphicsHandler.init();
                    console.log('üé® Graphics Handler initialized');
                    
                    // 4. Initialize Error Detection System
                    this.positionDetector = new SuddenPositionChangeDetector();
                    this.slingshotDetector = new SlingShotErrorDetector(this.positionDetector);
                    
                    // Start error monitoring
                    this.positionDetector.startMonitoring(this.changeLog);
                    this.slingshotDetector.startMonitoring(this.changeLog);
                    console.log('üîç Error Detection System initialized and monitoring');
                    
                    // 5. Create root application container
                    this.rootContainer = new BaseContainer('app-root', null, 'application');
                    console.log('üè† Root application container created');
                    
                    // 6. Create ToolsContainer as child of root
                    this.toolsContainer = new ToolsContainer('tools-container', this.rootContainer, {
                        panelPosition: 'left',
                        isPanelOpen: true,
                        toolLayout: 'grid',
                        theme: 'dark',
                        selectionMode: 'single',
                        allowedToolTypes: ['brush', 'text', 'shape', 'selector', 'eraser', 'container', 'drawing', 'form'],
                        toolCategories: ['drawing', 'text', 'shapes', 'selection', 'container', 'form'],
                        dropZones: ['canvas-area']
                    });
                    
                    // 7. Assign DOM element to container and set Event Handler
                    const toolsElement = document.getElementById('tools-container');
                    if (!toolsElement) {
                        throw new Error('Tools container element not found in DOM');
                    }
                    this.toolsContainer.element = toolsElement;
                    this.toolsContainer.eventHandler = this.eventHandler;  // Assign Event Handler
                    this.toolsContainer.graphicsHandler = this.graphicsHandler;  // Assign Graphics Handler
                    console.log('üîß ToolsContainer created and linked to DOM');

                    // 8. Create FormBuilderCanvas as child of root
                    this.formBuilderCanvas = new FormBuilderCanvas('canvas-area', this.rootContainer, {
                        backgroundColor: '#f8f9fa',
                        borderStyle: '2px dashed #dee2e6',
                        snapToGrid: true,
                        showGrid: true,
                        allowOverlap: false,
                        validDropSources: ['tools-container'],
                        allowedToolTypes: ['container', 'form', 'drawing', 'base-user-container']
                    }, this.changeLog);
                    
                    // Assign DOM element and handlers to canvas
                    const canvasElement = document.getElementById('canvas-area');
                    if (!canvasElement) {
                        throw new Error('Canvas area element not found in DOM');
                    }
                    this.formBuilderCanvas.element = canvasElement;
                    this.formBuilderCanvas.eventHandler = this.eventHandler;
                    this.formBuilderCanvas.graphicsHandler = this.graphicsHandler;
                    
                    // Initialize the canvas
                    const canvasInitResult = await this.formBuilderCanvas.initializeContainer();
                    if (!canvasInitResult.success) {
                        throw new Error(`Failed to initialize FormBuilderCanvas: ${canvasInitResult.error}`);
                    }
                    console.log('üìã FormBuilderCanvas created and initialized');

                    // 7. Create and attach behaviors
                    await this.initializeBehaviors();
                    
                    // 7. Create tools and setup initial state
                    this.createDrawingTools();
                    
                    // 8. Setup reactive listeners
                    this.setupReactiveListeners();
                    
                    // 9. Initial render through proper channels
                    await this.initialRender();
                    
                    this.systemInitialized = true;
                    console.log('ÔøΩ Reactive architecture initialized successfully!');
                    
                } catch (error) {
                    console.error('‚ùå System initialization failed:', error);
                    throw error;
                }
            }

            async initializeBehaviors() {
                // Create and attach toggle behavior
                this.toggleBehavior = new ToolPanelToggleBehavior();
                
                this.toggleBehavior.attachToContainer(this.toolsContainer, {
                    buttonEnabled: true,
                    buttonSymbols: { open: '‚ò∞', closed: '‚ñ∂' },
                    buttonSize: { width: 30, height: 30 },
                    animationEnabled: true,
                    persistState: false,
                    graphicsHandler: this.graphicsHandler  // Pass Graphics Handler reference
                });
                console.log('üîÑ Toggle behavior attached with Graphics Handler integration');

                // Create and attach drag and drop behavior
                this.dragAndDropBehavior = new DragAndDropBehavior();
                
                const dragAttachResult = this.dragAndDropBehavior.attachToBehavior(this.toolsContainer);
                if (dragAttachResult.success) {
                    // Configure the behavior with FormBuilderCanvas as drop target
                    this.dragAndDropBehavior.configureBehavior({
                        enabled: this.toolsContainer.dragEnabled,
                        dragThreshold: 5,
                        dragAxis: 'both',
                        showDragPreview: true,
                        previewOpacity: this.toolsContainer.dragPreview.opacity,
                        validDropZones: ['canvas-area'], // HTML element ID for validation
                        dropTargetContainers: [this.formBuilderCanvas], // Container object for handling
                        returnOnFailedDrop: this.toolsContainer.returnOnFailedDrop,
                        throttleMove: 16
                    });
                    
                    // Pass references for coordination
                    this.toolsContainer.dragAndDropBehavior = this.dragAndDropBehavior;
                    this.formBuilderCanvas.dragAndDropBehavior = this.dragAndDropBehavior;
                    console.log('üéØ DragAndDropBehavior attached and configured with FormBuilderCanvas');
                } else {
                    console.error('‚ùå Failed to attach DragAndDropBehavior:', dragAttachResult);
                }

                // 8. Set up reactive panel state changes
                this.toggleBehavior.onPanelStateChange = () => {
                    console.log('ÔøΩ Panel state changed, updating through Graphics Handler...');
                    this.requestPanelUpdate();
                };
            }

            createDrawingTools() {
                // Add Base User Container as the primary form building tool
                const containerTool = ToolsContainer.createToolItem('base-user-container', 'User Container', 'container', {
                    icon: 'üì¶', 
                    description: 'Base User Container - Foundation for all form elements'
                });

                // Add the container tool to the toolbar
                this.toolsContainer.addTool(containerTool);
                console.log(`üîß Added tool: ${containerTool.icon} ${containerTool.name}`);

                // Note: Tool selection and activation will be handled by Event Handler
                // when user interacts with the tool directly
                
                console.log('üîß Base User Container tool added to toolbar');
            }

            setupReactiveListeners() {
                // Listen for tool selection changes through ChangeLog
                this.changeLog.subscribe('tools.selection.changed', (data) => {
                    this.handleToolSelectionChange(data);
                });
                
                // Listen for panel state changes
                this.changeLog.subscribe('panel.state.changed', (data) => {
                    this.handlePanelStateChange(data);
                });
                
                // Listen for graphics operations completion
                this.changeLog.subscribe('current_context_meta.graphics.animations', (data) => {
                    this.handleAnimationComplete(data);
                });
            }

            async initialRender() {
                // Render tools through Graphics Handler coordination
                await this.renderToolsReactive();
                
                // Update status through reactive pattern
                this.updateStatusReactive();
                
                // Set initial panel state through Graphics Handler
                await this.requestPanelUpdate();
            }

            async renderToolsReactive() {
                const toolsGrid = document.getElementById('tools-grid');
                if (!toolsGrid) {
                    console.error('‚ùå Tools grid element not found');
                    return;
                }
                
                // Clear grid through Graphics Handler
                await this.graphicsHandler.updateComponentStyle({
                    componentId: 'tools-grid',
                    styles: { innerHTML: '' }  // Clear content
                });

                // Create tool elements without direct event listeners
                for (const tool of this.toolsContainer.tools) {
                    const toolElement = this.createToolElementReactive(tool);
                    toolsGrid.appendChild(toolElement);
                }
                
                console.log('üé® Tools rendered through reactive pattern');
            }

            createToolElementReactive(tool) {
                const toolDiv = document.createElement('div');
                toolDiv.className = 'tool-item';
                toolDiv.dataset.toolId = tool.toolId;
                toolDiv.id = `tool-${tool.toolId}`;  // Ensure unique ID for Graphics Handler
                
                // Add drag attributes for DragAndDropBehavior
                toolDiv.draggable = tool.isDraggable !== false;
                toolDiv.dataset.dragType = 'tool';
                toolDiv.dataset.toolType = tool.type;
                
                // Note: Tool states (selected/active) will be managed by Event Handler
                // and applied through Graphics Handler when needed

                toolDiv.innerHTML = `
                    <div class="tool-icon">${tool.icon}</div>
                    <div class="tool-name">${tool.name}</div>
                `;

                // NO EVENT LISTENERS - Let IO Handler capture inputs
                toolDiv.title = tool.description;

                return toolDiv;
            }

            // Note: Tool selection now handled directly by Event Handler through drag and drop interactions
            // No separate selection methods needed

            async requestPanelUpdate() {
                try {
                    // Request panel state change through Graphics Handler
                    const panelWidth = this.toolsContainer.isPanelOpen ? '200px' : '0px';
                    
                    await this.graphicsHandler.updateComponentStyle({
                        componentId: 'tools-container',
                        styles: { width: panelWidth },
                        options: { batch: false, immediate: false }
                    });
                    
                    // Update CSS classes for additional styling
                    const toolsElement = document.getElementById('tools-container');
                    if (toolsElement) {
                        if (this.toolsContainer.isPanelOpen) {
                            toolsElement.classList.remove('panel-collapsed');
                            toolsElement.classList.add('panel-open');
                        } else {
                            toolsElement.classList.remove('panel-open');
                            toolsElement.classList.add('panel-collapsed');
                        }
                    }
                    
                    this.updateStatusReactive();
                    console.log('üé® Panel update requested through Graphics Handler');
                } catch (error) {
                    console.error('‚ùå Panel update failed:', error);
                }
            }

            // Event handlers for reactive architecture
            handleToolSelectionChange(data) {
                console.log('üîÑ Tool selection changed:', data.toolId);
                this.updateStatusReactive();
            }

            handlePanelStateChange(data) {
                console.log('üîÑ Panel state changed:', data);
                this.updateStatusReactive();
            }

            handleAnimationComplete(data) {
                console.log('üé® Animation completed:', data);
            }

            updateStatusReactive() {
                // Note: Tool selection state now managed by Event Handler
                // For status display, we'll show first tool or none
                const currentTool = this.toolsContainer.tools.length > 0 ? this.toolsContainer.tools[0] : null;
                const currentMode = this.getCurrentMode();
                
                // Update status through DOM (acceptable for status display)
                const elements = {
                    currentTool: document.getElementById('current-tool'),
                    toolCount: document.getElementById('tool-count'),
                    panelStatus: document.getElementById('panel-status'),
                    appMode: document.getElementById('app-mode'),
                    modeToggle: document.getElementById('mode-toggle')
                };
                
                // Safe updates with error checking
                if (elements.currentTool) {
                    elements.currentTool.textContent = `Tool: ${currentTool ? currentTool.name : 'None'}`;
                }
                if (elements.toolCount) {
                    elements.toolCount.textContent = `Tools: ${this.toolsContainer.tools.length}`;
                }
                if (elements.panelStatus) {
                    elements.panelStatus.textContent = `Panel: ${this.toolsContainer.isPanelOpen ? 'Open' : 'Closed'}`;
                }
                if (elements.appMode) {
                    elements.appMode.textContent = `App Mode: ${currentMode.charAt(0).toUpperCase() + currentMode.slice(1)}`;
                }
                if (elements.modeToggle) {
                    const isDesignMode = currentMode === 'design';
                    elements.modeToggle.textContent = isDesignMode ? 'üîç Switch to Preview' : 'üé® Switch to Design';
                    elements.modeToggle.className = `status-item mode-toggle-btn ${isDesignMode ? '' : 'preview-mode'}`;
                }
            }

            // ========================
            // GLOBAL MODE MANAGEMENT
            // ========================

            /**
             * Set global application mode
             * @param {string} newMode - 'design' or 'preview'
             */
            setApplicationMode(newMode) {
                const availableModes = this.changeLog.getValue('application.available_modes', ['design', 'preview']);
                
                if (!availableModes.includes(newMode)) {
                    console.error(`‚ùå Invalid mode: ${newMode}. Available modes:`, availableModes);
                    return { success: false, error: `Invalid mode: ${newMode}` };
                }

                const oldMode = this.changeLog.getValue('application.mode');
                this.changeLog.setValue('application.mode', newMode);
                
                console.log(`üéõÔ∏è Application mode changed: ${oldMode} ‚Üí ${newMode}`);
                
                // Update status bar to show current mode
                this.updateStatusReactive();
                
                // Trigger global mode change event for all components
                this.eventHandler.triggerGlobal?.('mode-changed', {
                    oldMode,
                    newMode,
                    timestamp: Date.now()
                });

                return {
                    success: true,
                    oldMode,
                    newMode,
                    changeLog: {
                        type: 'application_mode_changed',
                        oldMode,
                        newMode,
                        timestamp: Date.now()
                    }
                };
            }

            /**
             * Get current application mode
             */
            getCurrentMode() {
                return this.changeLog.getValue('application.mode', 'design');
            }

            /**
             * Toggle between design and preview modes
             */
            toggleApplicationMode() {
                const currentMode = this.getCurrentMode();
                const newMode = currentMode === 'design' ? 'preview' : 'design';
                return this.setApplicationMode(newMode);
            }

            /**
             * Check if mode switching is enabled
             */
            isModeSwitchingEnabled() {
                return this.changeLog.getValue('application.mode_switching_enabled', true);
            }

            // Public API for debugging (maintaining compatibility)
            getContainer() { return this.toolsContainer; }
            getState() { return this.toolsContainer?.getState(); }
            // Note: Tool interaction now handled through Event Handler - no direct selectTool method
        }

        // ========================
        // SYSTEM INITIALIZATION
        // ========================

        // Initialize the reactive application when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                window.toolsApp = new ReactiveToolsApplication();
                
                // Add mode toggle button event listener
                setTimeout(() => {
                    const modeToggleBtn = document.getElementById('mode-toggle');
                    if (modeToggleBtn) {
                        modeToggleBtn.addEventListener('click', () => {
                            if (window.toolsApp?.isModeSwitchingEnabled()) {
                                const result = window.toolsApp.toggleApplicationMode();
                                if (result.success) {
                                    console.log(`üéõÔ∏è Mode toggled: ${result.oldMode} ‚Üí ${result.newMode}`);
                                } else {
                                    console.error('‚ùå Mode toggle failed:', result.error);
                                }
                            } else {
                                console.warn('‚ö†Ô∏è Mode switching is disabled');
                            }
                        });
                        console.log('üéõÔ∏è Mode toggle button event listener added');
                    }
                }, 100); // Small delay to ensure DOM is ready
                
            } catch (error) {
                console.error('‚ùå Failed to initialize application:', error);
            }
        });

        // Debug helpers for console (maintaining compatibility)
        window.debugTools = {
            getContainer: () => window.toolsApp?.getContainer(),
            getState: () => window.toolsApp?.getState(),
            // Note: Tool selection now handled by Event Handler - no direct methods
            getGraphicsHandler: () => window.toolsApp?.graphicsHandler,
            getEventHandler: () => window.toolsApp?.eventHandler,
            getDragAndDropBehavior: () => window.toolsApp?.dragAndDropBehavior,
            testDrag: (toolId) => {
                const behavior = window.toolsApp?.dragAndDropBehavior;
                const tool = window.toolsApp?.toolsContainer?.getTool(toolId);
                if (behavior && tool) {
                    console.log('üß™ Testing drag for tool:', toolId);
                    return behavior.startDrag({
                        target: { id: toolId },
                        position: { x: 100, y: 100 },
                        event: null
                    });
                }
                return 'Tool or behavior not found';
            },
            clearCache: () => {
                localStorage.removeItem('panel-state');
                console.log('‚úÖ Panel state cache cleared');
                return 'Cache cleared successfully';
            }
        };

        // ========================
        // TEMPORARY DRAG EVENT LISTENERS (Proof of Concept)
        // ========================
        
        // Add drag event listeners after initialization
        document.addEventListener('dragstart', (event) => {
            const toolElement = event.target.closest('.tool-item');
            if (toolElement && window.toolsApp?.dragAndDropBehavior) {
                const toolId = toolElement.id?.replace('tool-', '') || 'unknown';
                console.log('üéØ HTML5 Drag started for tool:', toolId);
                
                // Store drag data
                event.dataTransfer.setData('text/plain', toolId);
                event.dataTransfer.effectAllowed = 'copy';
                
                // Trigger DragAndDropBehavior
                try {
                    const result = window.toolsApp.dragAndDropBehavior.startDrag({
                        target: { id: toolId, type: toolId },
                        position: { x: event.clientX, y: event.clientY },
                        event: event
                    });
                    console.log('üéØ DragAndDropBehavior.startDrag result:', result);
                } catch (error) {
                    console.error('‚ùå Error in startDrag:', error);
                }
            }
        });
        
        document.addEventListener('dragover', (event) => {
            // Prevent default to allow drop
            event.preventDefault();
            event.dataTransfer.dropEffect = 'copy';
        });
        
        document.addEventListener('drop', (event) => {
            event.preventDefault();
            
            const dropZone = event.target.closest('.canvas-area');
            if (dropZone && window.toolsApp?.dragAndDropBehavior) {
                const toolId = event.dataTransfer.getData('text/plain');
                console.log('üéØ HTML5 Drop detected - tool:', toolId);
                
                // Calculate drop position
                const rect = dropZone.getBoundingClientRect();
                const dropPosition = {
                    x: event.clientX - rect.left,
                    y: event.clientY - rect.top
                };
                
                // Trigger DragAndDropBehavior
                try {
                    const result = window.toolsApp.dragAndDropBehavior.completeDrop({
                        target: { id: 'canvas-area' },
                        position: dropPosition,
                        event: event
                    });
                    console.log('üéØ DragAndDropBehavior.completeDrop result:', result);
                } catch (error) {
                    console.error('‚ùå Error in completeDrop:', error);
                }
            }
        });

        console.log('üé® Reactive ToolsContainer loaded. Architecture compliant!');
        console.log('üîß Try debugTools.getGraphicsHandler() in console!');
    </script>
</body>
</html>